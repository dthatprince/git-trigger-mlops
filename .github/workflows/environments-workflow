name: Diabetes Prediction

on:
  push:
    branches:
      - main

jobs:
  experiment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: azure/login@v1
        with:
          tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          client_id: ${{ secrets.AZURE_CLIENT_ID }}
          client_secret: ${{ secrets.AZURE_CLIENT_SECRET }}

      - uses: azure/machinelearning@v1
        with:
          subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          workspace_name: myworkspace

      - name: Train model
        run: |
          python train.py diabetes-dev-folder

  production:
    needs: experiment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: azure/login@v1
        with:
          tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          client_id: ${{ secrets.AZURE_CLIENT_ID }}
          client_secret: ${{ secrets.AZURE_CLIENT_SECRET }}

      - uses: azure/machinelearning@v1
        with:
          subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          workspace_name: myworkspace

      - name: Train model
        run: |
          python train.py diabetes-prod-folder

      - name: Approve production job
        if: ${{ success('experiment') }}
        uses: actions/github-script@v1
        with:
          script: |
            const { Octokit } = require('@octokit/core');

            const octokit = new Octokit({
              auth: process.env.GITHUB_TOKEN,
            });

            await octokit.post(`/repos/${process.env.GITHUB_REPOSITORY}/actions/runs/${github.run_id}/approve`);

